<link type="text/css" href="/javascripts/css/ui-lightness/jquery-ui-1.8.16.custom.css" rel="stylesheet" />
<!--<script type="text/javascript" src="/javascripts/js/jquery-1.6.2.min.js"></script>-->
<!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>-->
<script type="text/javascript" src="/javascripts/js/jquery-ui-1.8.16.custom.min.js"></script>

<head>
	<title>VtagO - <%= @page_title %></title>
</head>

<body>
	<!--Content Section -->
	<div id="content_sec">
		<div id="left_content">
			<div class="video-category" id="tab1">
				<div  class="heading-list-edit"><h1><%= @page_title %></h1></div>
				<% if @video.video_taggees.any? %>
					<div class="wrapper_list_view">
						<%= form_for @video, :url => "/video/#{@video.fb_id}/update_tags#{"/new" if @new}" do |f| %>
							<div id="video_taggees">
								<table  id="edit_tags_wrappper">
									<tr>
										<td id="tag_table">
                      <%= f.fields_for :video_taggees do |tag| %>
                        <div class="edit_box radious_6 edit_box_center">
                          <div id="face_tag" class="ui-widget">
                            <div class="left delete_box_tag">
                              <img src='/images/gallery_delete.png' class='gallery_delete'>
                            </div>
                            <div class="image_border radious_6">
                              <img class="gallary_image" src="<%= "#{tag.object.img_path}" %>" width="70" height="80">
                            </div>
                            <label for="tags">Who is this? </label>
                            <br>
                              <%= tag.text_field :contact_info, :class => "contact_info" %>
                              <%= tag.hidden_field :fb_id, :class =>"fb_id" %>
                              <%= tag.hidden_field :id %>
                              <%= tag.check_box :_destroy, :class => 'destroy', :style => 'display:none;' %>
                            <br>
                          </div>
                        </div>
											<% end %>
										</td>
									</tr>
								</table>
								<a class="radious_6" id="add_new_tag">Add another Vtag</a>
								<br>
								<br class="clear" />
								<div id="updade_footer">
									<div><input class="site_button radious_6" type="submit" onclick = "update_fb_ids();" value="Update video" name="commit"></div>
								</div>
							</div>
						<% end %>
					</div>
				<% else %>			
					<h2> Sorry, no faces found in this video </h2>
					<br class="clear" />
					<div>
						<p><input type="button" onclick="location.href='<%= @video.uri %>'" value="Back" name="back"></p>
					</div>		
				<% end %>
			</div>
		</div>
		<%= render :partial => "sidebars/single_video_sidebar" %>
    <br class="clear" />
	</div>
  <!--Content Section End -->
 </div>
</body>

<script type="text/javascript">
  var tags_count = <%= @video.video_taggees.count %>;

  function render_list_item(ul, item) {
    return $("<li />")
    .data("item.autocomplete", item)
    .append("<a><img class=friends_pic src=https://graph.facebook.com/" +item.id+ "/picture/ width=23 height=23>" + item.value + "</a>")				
    .appendTo(ul);
  }

  function add_autocomplete(elem) {
    elem.autocomplete({
       source: <%= raw @friends.to_json %>,
       minLength: 1,
       select: function(event, ui) { 
         $(this).parent().find('.fb_id').val(ui['item']['id']);
       }
     }).data("autocomplete")._renderItem = render_list_item;
  }

  $(document).ready(function(){
    $(".contact_info").each(function() { add_autocomplete($(this)) } );

    $('.gallery_delete').hide();

    // Display/hide the tag remove icon
    $(".edit_box").live({
      mouseenter:
        function() {
          $('.gallery_delete').hide();
          $(this).find('.gallery_delete').show();
        },
      mouseleave:
        function() {
          $('.gallery_delete').hide();
        }
      }
    );

    //display the add new tags box
    $('#add_new_tag').click(function(){
      $('#new_tag').show();

      var new_tag_d=$(
        "<div class='edit_box edit_box_new radious_6'>"+ 
          "<div>" + 
            "<div class='left delete_box_tag'>" + 
              "<img src='/images/gallery_delete.png' class='gallery_delete'>" + 
            "</div>" + 
            "<div id='new_tag' class='avatar_border radious_6'>" + 
              "<img src='/images/avatar.png' width='55' height='60'>" + 
            "</div>" + 
            "<label class ='new_tag_label' for='tags'>Add another Vtag</label>" + 
            "<br>" + 
            "<input type='hidden' name='video[video_taggees_attributes][" + tags_count + "][fb_id]' id='video_video_taggees_attributes_" + tags_count + "_fb_id' class='fb_id'> " +
            "<input type='text' value='' size='30' name='video[video_taggees_attributes][" + tags_count + "][contact_info]' id='video_video_taggees_attributes_" + tags_count + "_contact_info' class='contact_info ui-autocomplete-input' autocomplete='off' role='textbox' aria-autocomplete='list' aria-haspopup='true'>" +
          "</div>" +
        "</div>");

      new_tag_d.appendTo('#tag_table');
      add_autocomplete(new_tag_d.find('.contact_info'));

      tags_count += 1;
    });

    // Remove the appended new tag div
    $('#tag_table').on('click', '.gallery_delete',function() {
      var box = $(this).closest('.edit_box');
      box.find('.destroy').attr("checked", true);
      box.hide();
    });
  });
</script>